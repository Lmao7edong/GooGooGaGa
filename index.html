<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>My Profile</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@900&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Noto Sans JP', sans-serif;
            background: #000;
            color: #fff;
            cursor: default;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation; /* Улучшает отзывчивость на мобильных */
        }
        
        #background-video {
            position: fixed;
            right: 0;
            bottom: 0;
            min-width: 100%;
            min-height: 100%;
            z-index: -1;
            filter: brightness(0.6);
        }
        
        #loader {
            position: fixed;
            bottom: 15%;
            left: 0;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1000;
            opacity: 1;
            transition: opacity 1s ease-out;
        }
        
        .title {
            font-size: 2rem;
            margin-bottom: 1.2rem;
            color: #e8d8b0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            letter-spacing: 3px;
            background: linear-gradient(to right, #e8d8b0, #c9a66b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
            font-weight: 900;
            text-transform: uppercase;
        }
        
        .progress-container {
            width: 50%;
            max-width: 400px;
            height: 4px;
            background: rgba(200, 160, 100, 0.3);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(to right, #e8d8b0, #c9a66b);
            transition: width 0.1s linear;
        }
        
        #scary-video {
            position: fixed;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            display: none;
            z-index: 100;
        }
        
        #consent-trigger {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
        }
    </style>
</head>
<body>
    <video id="background-video" autoplay muted loop playsinline>
        <source src="gameplay.mp4" type="video/mp4">
    </video>
    
    <div id="loader">
        <div class="title">Welcome to My Account</div>
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
    </div>
    
    <video id="scary-video" preload="auto">
        <source src="scary.mp4" type="video/mp4">
    </video>
    
    <audio id="ambient-sound" preload="auto" loop>
        <source src="ambient.mp3" type="audio/mpeg">
    </audio>
    
    <div id="consent-trigger"></div>

    <script>
        // Усиленная конфигурация
        const LOAD_DURATION = 4500;
        const DELAY_BEFORE_SCARE = 1000;
        const FADE_OUT_DURATION = 1000;
        const MEDIA_LOAD_TIMEOUT = 3000; // Таймаут загрузки медиа
        const ACTIVITY_CHECK_INTERVAL = 250; // Частота проверки активности
        
        let userConsentGiven = false;
        let progressCompleted = false;
        let mediaLoaded = false;
        let activityDetected = false;
        let activityCheckInterval;
        
        // Элементы
        const elements = {
            loader: document.getElementById("loader"),
            progressBar: document.getElementById("progressBar"),
            bgVideo: document.getElementById("background-video"),
            scaryVideo: document.getElementById("scary-video"),
            consentTrigger: document.getElementById("consent-trigger"),
            ambientSound: document.getElementById("ambient-sound")
        };
        
        // 1. Усиленная инициализация
        async function init() {
            try {
                // Параллельная загрузка всего
                await Promise.all([
                    loadMedia(),
                    new Promise(resolve => {
                        elements.bgVideo.play().then(resolve).catch(resolve);
                        setupActivityMonitoring();
                        animateProgressBar();
                    })
                ]);
                
                console.log("Initialization complete");
            } catch (e) {
                console.error("Initialization failed:", e);
                // Fallback: запускаем сценарий без звука
                fallbackScenario();
            }
        }
        
        // 2. Надежная загрузка медиа с таймаутом
        function loadMedia() {
            return new Promise((resolve) => {
                const timer = setTimeout(() => {
                    console.warn("Media loading timeout");
                    resolve();
                }, MEDIA_LOAD_TIMEOUT);
                
                elements.scaryVideo.load();
                elements.ambientSound.load();
                
                const checkLoaded = () => {
                    if (elements.scaryVideo.readyState > 3 && elements.ambientSound.readyState > 3) {
                        clearTimeout(timer);
                        mediaLoaded = true;
                        resolve();
                    }
                };
                
                elements.scaryVideo.addEventListener('loadeddata', checkLoaded);
                elements.ambientSound.addEventListener('loadeddata', checkLoaded);
                checkLoaded(); // На случай если уже загружено
            });
        }
        
        // 3. Супер-мониторинг активности
        function setupActivityMonitoring() {
            const events = [
                'mousemove', 'mousedown', 'wheel',
                'touchstart', 'touchmove', 'pointermove',
                'keydown', 'click'
            ];
            
            const handleActivity = () => {
                if (!activityDetected) {
                    activityDetected = true;
                    requestAudioPermission();
                }
            };
            
            events.forEach(e => {
                document.addEventListener(e, handleActivity, {passive: true});
            });
            
            // Дополнительная проверка через интервал
            activityCheckInterval = setInterval(() => {
                if (activityDetected && !userConsentGiven) {
                    requestAudioPermission();
                }
            }, ACTIVITY_CHECK_INTERVAL);
        }
        
        // 4. Улучшенный запрос разрешения на звук
        function requestAudioPermission() {
            if (userConsentGiven || !mediaLoaded) return;
            
            userConsentGiven = true;
            console.log("Requesting audio permission");
            
            // Важная хитрость: сначала воспроизводим muted, затем включаем звук
            elements.ambientSound.muted = true;
            elements.ambientSound.play()
                .then(() => {
                    console.log("Ambient playback started");
                    elements.ambientSound.muted = false;
                    elements.scaryVideo.muted = false;
                    
                    // Chrome требует дополнительного взаимодействия
                    document.body.addEventListener('click', unmuteAll, {once: true});
                })
                .catch(e => {
                    console.error("Ambient playback error:", e);
                    fallbackScenario();
                });
        }
        
        function unmuteAll() {
            elements.ambientSound.muted = false;
            elements.scaryVideo.muted = false;
        }
        
        // 5. Анимация прогресс-бара
        function animateProgressBar() {
            let startTime = Date.now();
            let loadInterval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / LOAD_DURATION * 100, 100);
                elements.progressBar.style.width = progress + '%';
                
                if (progress >= 100) {
                    progressCompleted = true;
                    clearInterval(loadInterval);
                    fadeOutElements();
                    
                    // Запуск скримера после задержки
                    setTimeout(startScareSequence, DELAY_BEFORE_SCARE);
                }
            }, 30);
        }
        
        // 6. Fallback-сценарий
        function fallbackScenario() {
            console.log("Running fallback scenario");
            elements.ambientSound.muted = true;
            elements.scaryVideo.muted = true;
            
            // Пытаемся продолжить без звука
            elements.ambientSound.play().catch(console.error);
            
            // Ускоренное завершение прогресса
            if (!progressCompleted) {
                elements.progressBar.style.width = '100%';
                fadeOutElements();
                setTimeout(startScareSequence, DELAY_BEFORE_SCARE);
            }
        }
        
        // 7. Плавное исчезновение элементов
        function fadeOutElements() {
            // Затухание эмбиента
            const fadeInterval = setInterval(() => {
                if (elements.ambientSound.volume > 0.05) {
                    elements.ambientSound.volume -= 0.05;
                } else {
                    elements.ambientSound.pause();
                    clearInterval(fadeInterval);
                }
            }, FADE_OUT_DURATION / 20);
            
            // Исчезновение загрузочного экрана
            elements.loader.style.opacity = '0';
        }
        
        // 8. Запуск скримера
        function startScareSequence() {
            elements.loader.style.display = 'none';
            elements.consentTrigger.style.display = 'none';
            
            elements.scaryVideo.style.display = 'block';
            elements.scaryVideo.currentTime = 0;
            
            // Пытаемся войти в полноэкранный режим
            const enterFullscreen = () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen()
                        .catch(e => console.log("Fullscreen error:", e));
                }
            };
            
            elements.scaryVideo.play()
                .then(() => {
                    enterFullscreen();
                })
                .catch(e => {
                    console.error("Scary video error:", e);
                    // Если не удалось воспроизвести, пробуем снова с muted
                    elements.scaryVideo.muted = true;
                    elements.scaryVideo.play()
                        .then(enterFullscreen)
                        .catch(e => console.error("Fallback video error:", e));
                });
        }
        
        // Запуск с обработкой возможных ошибок
        window.addEventListener('DOMContentLoaded', () => {
            init().catch(e => {
                console.error("Fatal initialization error:", e);
                fallbackScenario();
            });
        });
    </script>
</body>
</html>
